---
title: Проверка контроля доступа по запросу на слияние
slug: /base/pullrequest/ci-check
description: Функция проверки контроля доступа по запросу на слияние
---

Проверка шлюза запроса на слияние предоставляет возможность интегрировать сторонние конвейеры в запросы на слияние. 

Вот простая схема последовательности действий, объясняющая, как получить доступ к возможностям внешнего сервиса

![](https://images.gitee.ru/uploads/images/2021/0901/175609_cec4deeb_1841492.png 'Screenshot.png')

Как показано на рисунке выше, Gitee отправляет события и принимает пользовательские запросы на операции для завершения интеграции. Это означает, что Gitee необходимо предоставить уведомления о событиях вебхуков и интерфейсов API для приема запросов на обнаружение пользовательских операций.

Описание интерфейса

:::информационная подсказка

Для вызова интерфейса проверки требуются права администратора репозитория

:::

### Создание задачи проверки

> `POST` : /repos/{owner}/{repo}/check-runs

| Наименование параметра | Тип данных | Расположение параметра | Описание параметра |
|-----|------|--------|------|
| owner | string | path | Адрес пространства репозиториев принимает значение https://gitee.ru/oschina/git-osc например, `repo` принимает значение oschina |
| repo | string | path | Адрес репозитория, например, `repo` принимает значение git-osc |
| name | string | formData | Обязательный параметр, проверьте название задачи, например: `ci-pipeline-runn`
  |
| head_sha | string | formData | Обязательный параметр, отображает последний коммит SHA в ветке во время отправки кода.
| details_url | string | formData | Дополнительный. Содержит адрес домашней страницы службы проверки возможностей контроля доступа.
| status | string | formData | Дополнительный, текущее состояние задачи проверки. Возможные значения:<br/>- `в_очереди`: указывает на то, что задача проверки находится в очереди (значение по умолчанию)<br/>- `выполняется`: указывает на то, что задача выполняется<br/>- `выполнена`: указывает, что задача проверки выполнена |
| started_at | string | formData | Дополнительный, время запуска задачи проверки, формат времени должен соответствовать
| completed_at | string | formData | Дополнительный, время завершения задачи проверки, требуемый формат времени согласно стандарту `ISO 8601` |
| conclusion | string | formData | Дополнительный. Окончательный статус (завершение) задачи проверки. Может принимать одно из следующих значений: <br/><ul><li>`action_required`: Требуется действие.</li><li>`cancelled`: Отменено.</li><li>`failure`: Задача не выполнена.</li><li>`neutral`: Статус отсутствует.</li><li>`success`: Задача выполнена успешно.</li><li>`skipped`: Пропущено.</li><li>`stale`: Устаревшая.</li><li>`timed_out`: Время выполнения задачи истекло.</li></ul><br/>Когда задача проверки будет выполнена (`completed_at` принимает непустое значение или `status` установлен на `completed`), `conclusion` является обязательным параметром.<br/>Если поле приобретает значение `action_required`, подробный URL-адрес должен быть указан в `details_url`.<br/>Когда задача будет выполнена и предоставлено заключение, задаче проверки будет автоматически присвоен статус `completed`. Впоследствии изменить это заключение будет невозможно.
| output | object | formData | Дополнительный. Отчет об обнаружении предоставляется после завершения задачи проверки. Конкретную структуру данных см. в разделе ** "Структура данных отчета о проверке доступа "** ниже. |
| actions | objects | formData | Дополнительный. Отображает кнопку на интерфейсе управления доступом, чтобы напомнить пользователю о необходимости выполнения дополнительных действий.

### Получение конкретной задачи на проверку

> `GET` /repos/{owner}/{repo}/check-runs/{check_run_id}

| Наименование параметра | Тип данных | Описание параметра |
|-----|------|------|
| owner | string | Обязательный параметр. URL-адрес места, где находится репозиторий. Например, URL-адрес имеет значение "oschina", `repo` также примет значение "oschina" |
| repo | string | Обязательный параметр. Например, если URL-адрес репозитория имеет значение 'git-osc', параметр 'repo' примет значение 'git-osc'.
| check_run_id | integer | Идентификатор элемента проверки, возвращаемый после вызова API `Создать задачу проверки` и успешного создания задачи проверки |

### Обновление конкретной задачи проверки

> `PATCH` /repos/{owner}/{repo}/check-runs/{check_run_id}

| Наименование параметра | Тип данных | Расположение параметра | Описание параметра |
|-----|------|--------|------|
| owner | string | path | Адрес пространства  репозиториев taking https://gitee.ru/oschina/git-osc as an example, `repo` принимает значение "oschina" |
| repo | string | path | Адрес репозитория, например, `repo` принимает значение git-osc |
| name | string | formData | Обязательный параметр. Проверьте название задачи, например: ci-pipeline-run
| check_run_id | integer | formData | Идентификатор выполнения проверки, возвращаемый после успешного создания задачи проверки с помощью API 'Создание контрольного прогона'. |
| details_url | string | formData | Ссылка, предоставляемая службой контроля доступа |
| status | string | formData | Текущий статус. Значения: в_очереди, выполняется, выполнена. Значение по умолчанию: в_очереди |
| started_at | string | formData | Время начала задачи проверки, формат времени должен соответствовать стандарту ISO 8601 |
completed_at: Форматированная строка по стандарту ISO 8601, представляющая время завершения задачи проверки.
| conclusion | string | formData | Обязательный параметр, когда completed_at принимает непустое значение, или статус принимает значение "выполнена". Представляет собой окончательное заключение по задаче проверки. Значение может быть одним из следующих: требуется_действие, отменена, не_выполнена, нейтрально, успешно, пропущена, устарела, превышено_время_ожидания. Когда значение равно "требуется_действие", поле details_url должно содержать подробный URL-адрес. Примечание: Предоставление заключения автоматически присваивает задаче проверки статус "выполнена"
| output | object | formData | Отчет об обнаружении, может принимать различные выходные данные, конкретную структуру данных см. в разделе `Создание задачи проверки`->`Атрибут отчета задачи проверки`. |
| actions | objects | formData | Отображается кнопка на интерфейсе Gitee, конкретную структуру данных см.

### Получение аннотаций для конкретной задачи проверки

> `GET`：/repos/{owner}/{repo}/check-runs/{check_run_id}/annotations

| Наименование параметра | Тип данных | Расположение параметра | Описание параметра |
|-----|------|--------|------|
| owner | string | path | Адрес пространства  репозиториев принимает значение https://gitee.ru/oschina/git-osc as an example, `repo` принимает значение "oschina" |
| repo | string | path | Адрес репозитория, например, `repo` принимает значение git-osc |
| check_run_id | integer | - | Идентификатор элемента проверки, возвращаемый после вызова интерфейса "Создать задачу проверки" и успешного создания задачи проверки |
| per_page | integer | - | Дополнительный параметр, максимальный объем данных, который можно получить за один запрос, с максимальным значением 100, значение по умолчанию -  20 |
| page | integer | - | Дополнительный параметр, запрашиваемый номер страницы, значение по умолчанию -  1 |

### Получение задачи проверки, соответствующей определенному коммиту в указанном репозитории

> `GET` /repos/{owner}/{repo}/commits/{ref}/check-runs

| Наименование параметра | Тип данных | Расположение параметра | Описание параметра |
|-----|------|--------|------|
| owner | string | path | Адрес пространства  репозиториев taking https://gitee.ru/oschina/git-osc as an example, `repo` принимает значение "oschina" |
| repo | string | path | Адрес репозитория, например, `repo` принимает значение "git-osc" |
| ref | string | - | Укажите SHA указанного коммита в репозитории |
| check_name | string | - | Возвращает проверочные прогоны с указанным именем. |
| status | string | - | - |
| per_page | integer | - | - |
| page | integer | - | - |

Структура данных

### Структура данных отчета о результатах проверки

Отчет о проверке контроля доступа передается путем указания поля 'output' в 'задаче проверки контроля доступа' для определения и вывода конкретного содержимого отчета в Gitee. Gitee выполнит парсинг информации, содержащейся в отчете, и отобразит ее в деталях задачи проверки контроля доступа. Ниже приведена конкретная структура данных "Отчета о проверке контроля доступа":

| Наименование параметра | Тип данных | Описание параметра |
|-----|------|------|
| title | string | Обязательный параметр, название проверяемого отчета о задаче |
| summary | string | Обязательный параметр, краткий обзор контрольного списка, этот атрибут поддерживает `Markdown`.
| text | string | Дополнительный, подробное содержание элемента контрольного списка. Этот атрибут поддерживает формат Markdown
| annotations | array of objects | Дополнительный. Используется для объявления и аннотирования результатов анализа соответствующего кода. Конкретную структуру данных см. ниже в разделе "Структура данных аннотации анализа". |
| images | array of objects | Дополнительный. Добавьте изображения в отчет, и они будут отображаться в пользовательском интерфейсе. Для получения более подробной информации о структуре данных обратитесь к следующему разделу "Структура данных аннотаций".

### Проверка структуры данных свойств аннотаций в отчете

В отчете о проверке доступа свойство 'annotations' поля 'output' можно использовать для аннотирования информации об анализе в виде комментариев в коде, чтобы пользователи могли видеть подробные результаты анализа при просмотре кода.

> Аннотированные комментарии можно увидеть на вкладке "Подробности запроса на слияние > Файлы".

| Наименование параметра | Тип данных | Описание параметра |
|-----|------|------|
| path | string | Обязательный параметр, указывает путь к аннотируемому файлу, например: 'README.md', 'src/main/example.java' |
| start_line | integer | Обязательный параметр, номер начальной строки комментария |
| end_line | integer | Обязательный параметр, номер конечной строки комментария |
start_column | integer | Дополнительный, номер начального столбца для комментариев, пропускается, если значение start_line не совпадает с end_line.
Дополнительный, номер конечного столбца комментария. Пропускается, значение start_line не совпадает с end_line.
| annotation_level | string | Дополнительный, уровень аннотации. Конкретное значение может быть одним из следующих:<br/>- `notice`: Напоминание<br/>- `warning`: Предупреждение<br/>- `failure`: Сбой |
| message | string | Обязательный параметр, краткое описание обратной связи для этих строк кода |
| title | string | Дополнительный, название комментария |
| raw_details | string | Дополнительный, подробная информация о комментарии |

### Проверка структуры данных свойств изображения в отчете

В отчете о проверке контроля доступа атрибут 'images' поля 'output' можно использовать для добавления изображений в отчет декларативным способом. Изображения будут отображаться в пользовательском интерфейсе.

| Наименование параметра | Тип данных | Описание параметра |
|-----|------|------|
| alt | string | Обязательный параметр, название изображения |
| image_url | string | Обязательный параметр, URL-адрес изображения |
| caption | string | Описание изображения |

### Проверка структуры данных действий расширения задачи

В задаче проверки контроля доступа сторонние сервисы могут использовать атрибут `actions` для отображения кнопки на интерфейсе, связанном с проверкой контроля доступа, которая может быть использована для пассивного запуска взаимодействия между элементом проверки и сервисом, к которому он относится в детальных данных задачи проверки контроля доступа. Конкретная структура данных атрибута `access control check task extension actions` выглядит следующим образом:

| Наименование параметра | Тип данных | Описание параметра |
|-----|------|------|
| label | string | Обязательный параметр, метка, отображаемая в пользовательском интерфейсе |
| description | string | Обязательный параметр, описывает конкретную операцию. |
| identifier | string | Обязательный параметр, уникальный идентификатор операции расширения |

### Проверка описания структуры данных WebHook

Когда сторонний сервис вызывает интерфейс, связанный с проверкой контроля доступа, платформа будет асинхронно уведомлять сторонний сервис о соответствующих событиях через вебхук. Конкретная структура данных уведомления через вебхук выглядит следующим образом:

| Поле вебхука | Тип | Описание поля |
|------------|----|------|
| action | string | Это поле представляет тип события, инициированного текущим пользователем. Возможные значения:<br/><ul><li>`created`: Создание задачи проверки</li><li>`completed`: Когда статус задачи проверки принимает значение "выполнена"</li><li>`rerequested`: Когда пользователь повторно запускает задачу проверки в пользовательском интерфейсе</li><li>`requested_action`: Когда пользователь использует функциональные кнопки, предусмотренные пунктом проверки</li></ul>|
| requested_action | string | Значение уникального идентификатора `identifier`, настроенного сторонней службой проверки контроля доступа при создании задачи проверки в операции расширения задачи проверки контроля доступа (`actions`) |
| check_run | object | Подробная информация о запущенной проверке |
| project | object | Информация о репозитории, в котором находится запущенная задача проверки |
| sender | object | Информация о пользователе, запустившем операцию задачи проверки |

## Настройка запроса на слияние и правила допуска через защищенные ветки Admission Rules through Protected Branches

В стратегии защиты веток установите параметр "Требовать прохождения проверок статуса перед слиянием", установите флажок и нажмите кнопку "Сохранить". При создании последующих запросов на слияние, если проверка 'Требовать прохождения проверки статуса перед слиянием' окончится неудачей, разрешение на объединение запроса на слияние не будет получено.

:::tip Рекомендации

1. Можно отфильтровать только элементы проверки, выполненные за последнюю неделю
2. В случае неудачного завершения проверки "Требовать для объединения успешного статуса доступа"  администратор репозитория может обойти это ограничение и принудительно объединить запрос на слияние.

:::