---
title: Плагин Jenkins
origin-url: https://gitee.ru/help/articles/4193
---

# Оглавление

- [Оглавление](#Оглавление)
- [Введение](#Введение)
- [Поддерживаемые функции](#Поддерживаемые_функции)
  - [Планируемые функции](#Планируемые_функции)
- [Установка плагина](#Установка_плагина)
- [Настройка плагина](#Настройка_плагина)
  - [Добавление конфигурации ссылки Gitee](#Добавление_конфигурации_ссылки_Gitee)
    - [Создание новой задачи сборки](#Создание_новой_задачи_сборки)
- Глобальная настройка задач
- Настройка управления исходным кодом
    - [Настройка триггеров](#Настройка_триггеров)
    - [Настройка шагов после сборки](#Настройка_шагов_после_сборки)
      - [Обратная связь с Gitee по результатам сборки](#Обратная-связь-с-Gitee-по-результатам-сборки)
      - [Автоматическое объединение запроса на слияние при успешной сборке](#Автоматическое-объединение-запроса-на-слияние)
- [Создание вебхука проекта Gitee](#Создание-вебхука-проекта-Gitee)
- [Тестовая отправка запускает сборку](#Тестовая отправка_запускает_сборку)
      - [Тестирование запроса на слияние для запуска сборки](#Тестирование_запроса_на_слияние_для_запуска_сборки)
- [Переменные среды](#Переменные_среды)
- [Поддержка пользователей](#Поддержка_пользователей)
- [Вклад](#Вклад)
  - [Упаковка или выполнение тестов](#Упаковка_или_выполнение_тестов)

##Введение

Плагин Jenkins Gitee представляет собой плагин Jenkins, разработанный Gitee на основе [плагина GitLab](https://github.com/jenkinsci/gitlab-plugin). Он используется для настройки триггеров Jenkins для получения вебхука, отправляемого платформой Gitee, для автоматической непрерывной интеграции или непрерывного развертывания и может предоставлять обратную связь о статусе сборки платформе Gitee.

Поддерживаемые в настоящее время функции

- При отправке кода в Gitee настроенный вебхук запускает сборку задания Jenkins.
- Запись об отправке комментария запускает соответствующую версию сборки задачи Jenkins
- Отправляемый в проект Gitee запрос на слияние запускает Jenkins через настроенный вебхук
- Поддержка фильтрации команд [ci-skip] или запускающей сборку команды [ci-build].
- Фильтрация уже созданных версий коммита. Если это отправка ветки, то отфильтровывается отправка той же самой ветки. Если это запрос на слияние, то отфильтровывается тот же самый запрос на слияние.
- Фильтрация триггеров по названию ветки.
- Фильтрация регулярных выражений для запуска веток.
- Установка пароля проверки вебхука.
- Настраиваемые действия после сборки для комментирования результата сборки, вызванного запроса на слияние к соответствующему запросу на слияние в Gitee.
- Действие после сборки может быть настроено на автоматическое объединение с соответствующим запросом на слияние, когда сборка, инициированная запросом на слияние, будет успешно зваершена.
Что касается всех событий, связанных с запросами на слияние, то не запускайте сборку, если конфликты кода запроса на слияние не могут быть автоматически объединены; и, если функция комментирования запросов на слияние настроена, прокомментируйте запрос на слияние, чтобы указать на конфликт.
- Комментарии к запросам на слияние могут запускать сборку через вебхуки (если сборка закончится неудачно, их можно будет использовать для повторного запуска сборки из комментариев платформы Gitee)
- Поддержка настройки запросов на слияние  с целью избавиться от необходимости тестирования и фильтрации сборок триггеров (может использоваться для отказа от создания и развертывания тестовой среды, если тестирование не требуется)
- Поддерживает отмену текущей незавершенной сборки для того же запроса на слияние при запуске сборки и продолжает текущую сборку (несколько сборок для одного и того же запроса на слияние не ставятся в очередь, несколько разных сборок также не ставятся в очередь).

## Планируемые функции

1. Проверка запроса на слияние и прохождение теста запускают сборку (могут запускаться пользователями для развертывания и могут сочетаться с функцией автоматического объединения запроса на слияние для улучшения рабочего процесса).
2. Проверьте метод запуска для автоматического добавления вебхука в Gitee.

# Установка плагина

1. Установка в режиме онлайн
    - Перейдите в Управление Jenkins -> Управление плагинами -> Доступно
	- Введите справа значение фильтра: Gitee
    - Проверьте Gitee в дополнительном списке ниже (если Gitee нет в списке, нажмите "Проверить сейчас")
	- Нажмите "Загрузить сейчас" и установите после перезагркзки

![Описание изображения](https://images.gitee.ru/uploads/images/2018/0723/112748_b81a1ee3_58426.png )

2. Установка вручную
	- В списке [release](https://gitee.ru/oschina/Gitee-Jenkins-Plugin/releases) введите последнюю версию релиза и загрузите соответствующий файл XXX.hpi.
	- Перейдите в Управление Jenkins -> Управление плагинами -> Дополнительно
	- Выберите загруженный файл XXX.hpi в разделе "Загрузить файл плагина" и нажмите Загрузить
	- На следующей странице установите флажок "Перезапустить Jenkins, когда установка будет завершена и не будет запущено каких-либо заданий". - На следующей странице установите флажок "Перезапустить Jenkins, когда установка будет завершена и никаких заданий выполняться не будет".

![Описание изображения](https://images.gitee.ru/uploads/images/2018/0723/113303_2a1d0a03_58426.png )

# Настройка плагина

## Добавление конфигурации ссылки Gitee

1. Перейдите в Jenkins -> Упрпавление Jenkins -> Настроить систему -> Настройка Gitee -> связь с Gitee
2. Введите 'Gitee' или любое другое имя в поле 'Имя подключения'.
3. Введите полный URL-адрес Gitee в поле 'Gitee host URL': 'https://gitee.ru' (Доменное имя частного развертывания Gitee, введенное заказчиком частного развертывания Gitee)
4. Если личный токен Gitee API V5 не настроен в разделе `Учетные данные`, нажмите `Добавить` и выберите  `Jenkins`.
5. Выберите ``Домен``, затем ``Глобальные учетные данные``.
6. Задайте "Вид" как "Токен API Gitee".
7. ``Область применения`` Выберите нужную вам область применения
8. Введите свой личный токен Gitee для "Токена API Gitee", пройдя по адресу: <https://gitee.ru/profile/personal_access_tokens>
9. Введите нужные идентификатор и описание в полях `Идентификатор` и `Описание`.
10. Выберите ``Учетные данные``, а затем настроенный токен Gitee APIV5.
11. Нажмите "Дополнительно", чтобы указать в настройках, следует ли игнорировать ошибки SSL (в зависимости от вашей среды Jenkins) и установить измерение времени ожидания ответа соединения (в зависимости от вашего сетевого окружения).
12. Нажмите `Проверить соединение`, чтобы проверить, успешно ли установлена ссылка. Если это не удается, проверьте вышеуказанные шаги 3, 5, 6.

После успешной настройки она должна выглядеть следующим образом:
![Конфигурация ссылки Gitee](https://images.gitee.ru/uploads/images/2018/0716/185651_68707d16_58426.png)

### Создание новой задачи сборки

Перейдите в Jenkins -> Создать элемент, введите название "Gitee Test", выберите "Freestyle project" и сохраните, чтобы создать проект сборки.

### Глобальная настройка задач

В Глобальной настройке задач необходимо выбрать из предыдущего шага ссылку Gitee. Перейдите в меню Настроить -> Общие конкретной задачи (например, 'Gitee Test'), и выберите настроенное ранее соединение Gitee, как показано на рисунке:

![Глобальная настройка задач](https://images.gitee.ru/uploads/images/2018/0716/191715_9660237b_58426.png )

### Настройка управления исходным кодом

Перейдите к задаче (например, 'Gitee Test') Настроить -> вкладка "Управление исходным кодом"

1. Нажмите *Git*
2. Введите адрес вашего репозитория, например, ``git@your.gitee.server:gitee_group/gitee_project.git``
3. Нажмите кнопку *Дополнительно*, введите `origin` в поле *Name*, затем введите ``+refs/heads/*:refs/remotes/origin/* +refs/pull/*/MERGE:refs/pull/*/MERGE`` в поле *Refspec*.
Обратите внимание, что новая версия Jenkins больше не принимает описания нескольких ссылок, одновременно содержащих подстановочный знак *. Если вы хотите запускать только при нажатии, вы можете написать только первую часть; если вы хотите запускать только при запросе на слияние, вы можете написать только вторую часть. Для получения подробной информации смотрите следующее изображение : ![Описание изображения](https://images.gitee.ru/uploads/images/2020/0601/220940_0ce95dd0_58426.png )
4. В разделе "Учетные данные" введите имя пользователя и пароль, соответствующие URL-адресу https-репозитория git, или учетные данные ssh-ключа для ssh. Обратите внимание, что учетные данные токена Gitee API нельзя использовать для управления исходным кодом, они используются только для вызовов API в плагине Gitee.
5. Опция *Указатель ветки*:
6. Для входа в рабочий процесс с одним репозиторием: ``origin/${giteeSourceBranch}``
7. Для ввода рабочего процесса запроса на слияние: 'pull/${giteePullRequestIid}/MERGE'
Дополнительные варианты поведения
1. Для рабочих процессов с одним репозиторием, если вы хотите объединить ветку по умолчанию (ветку релиза) перед созданием ветки, в которую будет производиться пересылка, вы можете сделать следующее:
        1. Нажмите на выпадающий список *Добавить*.
		2. Выберите *Соединить перед сборкой*.
        3. Задайте  ``origin`` в *Имени репозитория* .
		4. Задайте  *Ветку для слияния* как ``${ReleaseBranch}``, которая является ветвкой для слияния по умолчанию (ветка релиза)
2. Для работы с запросом на слияние сервер Gitee уже предварительно объединил исходную ветку и целевую ветку запроса на слияние. Вы можете собрать ее напрямую. Если целевая ветка не является веткой по умолчанию (веткой релиза), вы также можете объединить ее перед сборкой.

Настройка как показано на рисунке:

![Настройка управления исходным кодом](https://images.gitee.ru/uploads/images/2018/0716/191913_ef0995f4_58426.png )

### Настройка триггеров

Перейдите к триггерам сборки  в настройках задачи: Настройки -> вкладка "Триггеры сборки"

1. Проверьте "Включенные триггеры Gitee" для необходимых вам правил запуска сборки, как, например, "Событие отправки кода" и "Открытые события запроса на слияние". Отмеченные события получат веб-ссылки и запустят сборку. Поддерживаемые в настоящее время триггерные события включают:
	- События отправки: событие отправки кода
Фиксация событий комментариев: События записи отправки комментариев
	- Открытые события запроса на слияние: Событие отправки запроса на слияние
	- Обновленные события запроса на слияние: Обновление событий запросов на слияние
Принятые события запроса на слияние: Принять/объединить события запросов на слияние
Закрытые события запроса на слияние: Закрыть запросы на слияние
	- Одобренные запросы на слияние: Событие для утвержденных запросов на слияние
	- Протестированные запросы на слияние: запускаются при успешном событии отправки запроса на слияние.
2. `Фильтры команд сборки` :
    - `Нет`: Нет фильтров
    - `[ci-skip] пропустить сборку`: Пропустить запуск сборки, если сообщение о коммите или описание запроса на слияние содержит команду `[ci-skip]`.
	- `[ci-build] запустить сборку`: сообщение о коммите
  или запустить сборку, если описание запроса на слияние включает команду `[ci-build]`.
3. Опция 'Игнорировать последний собранный коммит' позволяет пропускать уже собранные версии коммита.
4. Отменить неполную сборку по тем же запросам на слияние
5. `Игнорировать конфликты запросов на слияние` Этот параметр определяет, следует ли выполнять сборку при наличии конфликтов в запросе на извлечение.
6. Разрешенные ветки могут быть настроены таким образом, чтобы разрешить использование определенных веток, в настоящее время поддерживающих имена веток и регулярные выражения для фильтрации
7. `Секретный токен для вебхука Gitee WebHook` Этот параметр позволяет настроить пароль для вебхука, который должен соответствовать паролю, настроенному в вебхуках Gitee для запуска сборки.
8. Примечание: Если запроса на слияние не обладает статусом "автоматически объединяемый", сборка запущена не будет.
![Настройки триггера](https://images.gitee.ru/uploads/images/2021/0107/171932_e25c8359_2102225.png )

### Настройка шагов после сборки

Перейдите к настройке задачи после сборки: Настройка -> вкладка "Действия после сборки"

#### Обратная связь с Gitee по результатам сборки

1. Нажмите на выпадающий список "Добавить действие после сборки" и выберите: "Добавить заметку со статусом сборки в запросах на слияние Gitee"
2. В разделе `Дополнительно` вы можете настроить:
- Добавлять сообщение только для неудачных сборок: отправлять комментарии только для неудачных сборок в Gitee
- Настройте содержимое обзора для каждого статуса (содержимое может ссылаться на переменные среды Jenkins или пользовательские переменные среды).
3. Если эта функция включена, запросы на слияние со статусом,  исключающим автоматическое объединение, также могут быть проверены в Gitee

#### Автоматическое объединение запроса на слияние при успешной сборке

Нажмите на выпадающий список "Добавить действие после сборки" и выберите: "Принять запрос на слияние Gitee при успешном выполнении".

![Сборка после пошаговой настройки](https://images.gitee.ru/uploads/images/2018/0716/192304_0e323bc0_58426.png)

### Создание вебхука проекта Gitee

Введите набор проектов Gitee в настройках управления исходным кодом и перейдите в Управление -> вебхуки

1. Добавьте вебхуки и заполните поле URL-адреса URL-адресом, указанным в разделе "Настройки триггера: сборка при отправке изменения в Gitee. URL-адрес вебхука Gitee`, например: <http://127.0.0.1:8080/jenkins/project/fu>.
2. Пароль: Введите пароль вебхука, настроенный в пункте 5 нестроек триггера. Если пароль не задан, его можно оставить пустым.
3. Установите флажок ОТПРАВКА, Запрос на слияние

#### Тестовая отправка запускает сборку

1. Выберите ОТПРАВИТЬ вебхук в управлении вебхуками Gitee и нажмите на кнопку "Тестировать", чтобы увидеть состояние сборки задачи Jenkins.
2. Отредактируйте файл и отправьте его на странице проекта Gitee, после чего наблюдайте за статусом сборки задачи Jenkins.

#### Тестирование запроса на слияние для запуска сборки

1. В управлении вебхуками Gitee выберите вебхук запроса на слияние. Нажмите на кнопку "Тестировать" и проследите за состоянием сборки задачи Jenkins.
2. В проекте Gitee создайте запрос на слияние и наблюдайте за состоянием сборки задачи Jenkins.

##### Переменные среды

В настоящее время поддерживаются следующие переменные окружения. Обратите внимание, что при различных триггерах вебхуков некоторые переменные могут быть пустыми. Для получения более подробной информации, установите плагин EnvInject и проверьте переменные окружения во время сборки.

```java
    public Map<String, String> getBuildVariables() {
        MapWrapper<String, String> variables = new MapWrapper<>(new HashMap<String, String>());
        variables.put("giteeBranch", branch);
        variables.put("giteeSourceBranch", sourceBranch);
        variables.put("giteeActionType", actionType.name());
        variables.put("giteeUserName", userName);
        variables.put("giteeUserEmail", userEmail);
        variables.put("giteeSourceRepoHomepage", sourceRepoHomepage);
        variables.put("giteeSourceRepoName", sourceRepoName);
        variables.put("giteeSourceNamespace", sourceNamespace);
        variables.put("giteeSourceRepoURL", sourceRepoUrl);
        variables.put("giteeSourceRepoSshUrl", sourceRepoSshUrl);
        variables.put("giteeSourceRepoHttpUrl", sourceRepoHttpUrl);
        variables.put("giteePullRequestTitle", pullRequestTitle);
        variables.put("giteePullRequestDescription", pullRequestDescription);
        variables.put("giteePullRequestId", pullRequestId == null ? "" : pullRequestId.toString());
        variables.put("giteePullRequestIid", pullRequestIid == null ? "" : pullRequestIid.toString());
        variables.put("giteePullRequestTargetProjectId", pullRequestTargetProjectId == null ? "" : pullRequestTargetProjectId.toString());
        variables.put("giteePullRequestLastCommit", lastCommit);
        variables.put("giteePushCreated", created ? "true" : "false");
        variables.put("giteePushDeleted", deleted ? "true" : "false");
        variables.putIfNotNull("giteePullRequestState", pullRequestState);
        variables.putIfNotNull("giteeMergedByUser", mergedByUser);
        variables.putIfNotNull("giteePullRequestAssignee", pullRequestAssignee);
        variables.put("giteeTargetBranch", targetBranch);
        variables.put("giteeTargetRepoName", targetRepoName);
        variables.put("giteeTargetNamespace", targetNamespace);
        variables.put("giteeTargetRepoSshUrl", targetRepoSshUrl);
        variables.put("giteeTargetRepoHttpUrl", targetRepoHttpUrl);
        variables.put("giteeBefore", before);
        variables.put("giteeAfter", after);
        variables.put("giteeBeforeCommitSha", before);
        variables.put("giteeAfterCommitSha", after);
        variables.put("giteeRef", ref);
        variables.put("ref", ref);
        variables.put("beforeSha", beforeSha);
        variables.put("isTag", isTag);
        variables.put("sha", sha);
        variables.put("status", status);
        variables.put("stages", stages);
        variables.put("createdAt", createdAt);
        variables.put("finishedAt", finishedAt);
        variables.put("duration", buildDuration);
        variables.put("jsonBody", jsonBody);
        variables.put("noteBody", noteBody);
        variables.putIfNotNull("giteeTriggerPhrase", triggerPhrase);
        return variables;
    }

```

##### Поддержка пользователей

Если во время использования у вас возникнут какие-либо вопросы, просим отправлять отзывы в [Gitee Jenkins Issue](https://gitee.ru/oschina/Gitee-Jenkins-Plugin/issues).

Чтобы получить больше журналов для устранения неполадок, перед отправкой отзыва вы можете выполнить следующие действия:

1. Перейдите Jenkins -> Управление Jenkins -> Журнал системы
2. Нажмите на кнопку "Добавить новый регистратор журналов".
3. Введите "Плагин Gitee Jenkins". 
4. На следующей странице нажмите "Добавить" в разделе "Регистратор", введите в поле ввода  "com.git.jenkins",  на уровне журнала выберите "Все", затем сохраните.
5. После выполнения вышеописанных шагов вы можете просмотреть переведенный результат в журнале "Плагин Gitee Jenkins".

####Вклад

Вносите предложения по функциям сценария непрерывной интеграции или напрямую отправлять запросы на слияние для внесения вклада в разработку кода.

## Упаковка или выполнение тестов

Упакуйте файл hpi и выполните его в директории репозитория: `mvn package`

Выполняйте тесты напрямую: ``mvn hpi:run``