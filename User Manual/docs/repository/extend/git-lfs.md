---
title: Руководство по использованию GitLFS
authors:
  - name: No Mo
    url: https://gitee.ru/normalcoder
origin-url: https://gitee.ru/help/articles/4235
---

> Gitee (gitee.ru) поддержал функцию `Git LFS`, которая в настоящее время открыта для платных предприятий.

### Git-LFS

Git, являющийся лучшим в мире инструментом распределенного контроля версий, также является отличным инструментом управления файлами. Он дает участникам проекта возможность удаленной совместной работы над проектами, поэтому становится все более популярным среди профессионалов отрасли. Многие отличные платформы управления проектами, такие как отечественные

**Как избежать аварийных ситуаций?

Теперь давайте представим звезду сегодняшнего дня - Git LFS (Git Large File Storage), которая представляет собой технологию хранения больших файлов в Git.

В Git-репозиториях нетекстовые файлы, такие как различные мультимедийные файлы, программные артефакты, бинарные файлы и т. д., часто имеют большой размер. Управление ими непосредственно в Git приводит к быстрому увеличению размера репозитория, что в свою очередь влияет на скорость выполнения многих операций Git и выгрузки репозитория на удаленный сервер.

Git LFS - это расширенный инструмент для Git, который можно рассматривать как плагин. Проще говоря, он заменяет фактические файлы в Git-репозитории "указателями" и хранит их на удаленном LFS-сервере, отслеживая изменения этих файлов в локальном репозитории в режиме реального времени.

<img src="https://git-lfs.github.com/images/graphic.gif" alt="диаграмма, показывающая, как работает Git LFS" />

### Принцип

Согласно официальной документации Git LFS:

Git LFS - это функция, основанная на конфигурационном файле [.gitattributs](http://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E5%B1%9E%E6%80%A7) Git. Она использует фильтр `smudge` для поиска содержимого больших файлов на основе `pointer file`, а фильтр `clean` для создания новой версии pointer file при внесении изменений в большие файлы. Также используется хук `pre-push` для загрузки больших файлов на сервер Git LFS. Другими словами, когда выполняется `git-push` и коммит содержит большие файлы, отслеживаемые LFS, хук `pre-push` обнаруживает это и выполняет загрузку на сервер Git LFS.

Поэтому, если репозиторий содержит содержимое LFS, но вы не хотите проталкивать такие файлы при проталкивании, просто добавьте опцию `--no-verify`, например, так:


```bash
git push --no-verify
```

Опция `--no-verify` приказывает `git push` полностью пропустить хук `pre-push`.

Как упоминалось выше, для файлов, управляемых LFS, содержимое, хранящееся в локальном репозитории, на самом деле является файлом-указателем, и его формат похож на следующий:

```bash
$ git show HEAD:2.svg

version https://git-lfs.github.com/spec/v1
oid sha256:158213f90f8b27012034c6f58db63e1861b12aa122d98910de311bf1cb1e50a0
size 14651
(END)
```

`version` представляет собой версию LFS

`oid` представляет собой уникальное хэш-значение файлового объекта

`size` представляет собой размер файла

### Установка

Примечание: Следующие демонстрации установки и использования команд основаны на командной строке в Linux. Операции с графическим интерфейсом в Windows не рассматриваются из-за нехватки времени**.

Установите зависимости: Git >=1.8.5

Ситема Linux:

```bash
curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash

sudo apt-get install git-lfs
```

> <https://packagecloud.io/github/git-lfs/install#bash>

Для установки на другие операционные системы обратитесь к официальной документации по установке:

> <https://github.com/git-lfs/git-lfs#installing>

---

Настройка

+ **Шаг 1: Установите в Git-репозитории соответствующие конфигурации для репозитория:**

```bash
git lfs install
```

> Советы:
>
> Эта команда автоматически изменит конфигурационный файл Git `.gitconfig`, и это глобальное изменение. Она добавит в файл следующую конфигурацию:
>
> [filter "lfs"]
> clean = git-lfs clean -- %f
> smudge = git-lfs smudge -- %f
> process = git-lfs filter-process
> required = true

+ **Шаг 2: Выберите файлы, которые будут отслеживаться LFS:**.

```bash
$ git lfs track "*.svg"
Or specific to a file
$ git lfs track "2.png"
$ git lfs track "example.lfs"
```

> Советы:
>
Эта команда изменит конфигурационный файл `.gitattributes` в репозиторий (если файл не существует, он будет создан автоматически).
> См. ниже:
> $ cat .gitattributes
> *.svg filter=lfs diff=lfs merge=lfs -text
>*.png filter=lfs diff=lfs merge=lfs -text

Любопытные студенты могут спросить, каким образом я узнаю, какие файлы я отслеживаю?

Очень просто, эта проблема решается одной командой!

Для просмотра файлов, отслеживаемых в данный момент LFS, вы можете использовать команду 'git lfs ls-files'.

```bash
$ git lfs ls-files
9a3c7dae41 * 1.png
d61cf5835a * 2.png
158213f90f * 3.svg
```

> После введения команды `git add file`файл становится видимым и может быть отслежен.

Некоторые могут задаться вопросом: что делать, если они не хотят, чтобы LFS отслеживал определенный файл?

Очень просто - эта проблема решается всего оишь одной командой:

```bash
git lfs untrack "1.png"
```

Чтобы решить проблему любопытных студентов, мы продолжаем упомянутый ранее второй шаг. После выбора файлов, которые должны управляться LFS, лучше всего сначала сохранить настройки:

+ **Шаг 3: Сохранить и отправить настройки:**.

```bash
git add .gitattributes
git commit -m "add .gitattributes"
```

Краткое описание настройки:

**После установки Git LFS вы можете настроить функцию LFS в репозитории всего за три шага**, а именно:

```bash
#step 1
$ git lfs install

#step 2
$ git lfs track files

# step 3
$ git add .gitattributes
```

На самом деле, поскольку первый шаг является глобальной конфигурацией, его нужно выполнить только один раз. Для последующих складов, которые должны использовать LFS, нет необходимости выполнять его снова, если только конфигурация LFS не будет отменена на середине пути.

> Советы: Для отмены глобальных настроек LFS выполните команду `git lfs uninstall`

---

### Примеры использования

##### Сценарий 1

Однажды во время поиска интересных проектов на Gitee вы быстро находите ценный игровой проект и решаете немедленно создать его форк и клон:

```bash
$ git clone git@gitee.ru:hightest/lfs-demo.git my-project
Cloning into 'lfs-copy'...
Enter passphrase for key '/home/git/.ssh/id_ed25519':
remote: Enumerating objects: 24, done.
remote: Counting objects: 100% (24/24), done.
remote: Compressing objects: 100% (24/24), done.
remote: Total 24 (delta 7), reused 0 (delta 0), pack-reused 0
Receiving objects: 100% (24/24), done.
Resolving deltas: 100% (7/7), done.
Enter passphrase for key '/home/git/.ssh/id_ed25519':
Updating files: 100% (9/9), done.
Enter passphrase for key '/home/git/.ssh/id_ed25519':
Filtering content: 100% (5/5), 1.51 MiB | 257.00 KiB/s, done.
```
Вы только что внесли небольшую модификацию в файл примера example.lfs, а затем, кстати, и в git diff, чтобы увидеть изменения:

```bash
$cd my-project
# edit example.lfs
$ git diff
diff --git a/example.lfs b/example.lfs
index 9550b5b..8bfca2b 100644
--- a/example.lfs
+++ b/example.lfs
@@ -1,3 +1,3 @@
version https://git-lfs.github.com/spec/v1
-oid sha256:fa3b58d0150ccbaed40ab94fd5574ae8225e83117c076b586ef08ff38be8d923
-size 69
+oid sha256:d8f84506d6b9e804852c3b15b921893606b4c2cbe388d1cc118bd42101eed2a8
+size 63
(END)
```

`git diff` показывает неожиданные изменения; почему же возникает такое различие?

Если вы читали предыдущий раздел о принципах, то сразу поймете, что это разница в файле-указателе LFS, которая указывает на то, что загруженный вами репозиторий использует LFS для управления файлами.

Реальный размер файла репозитория составляет всего 132 байта, в то время как его фактический размер - 9,18 MiB (мебибайт), т.е., разница составляет несколько порядков.

Преимущества такого подхода вполне очевидны. Для очень больших файлов можно использовать очень маленькое пространство.

![image.png](https://images.gitee.ru/uploads/images/2021/0928/000246_0b965b05_7670704.png)

---

##### Сценарий 2

Как разработчик игр вы всегда хотели спроектировать и разработать увлекательную игру. Проект, использованный в Сценарии 1, вдохновил вас, и вы решили провести углубленную разработку на его основе. Вы добавили в этот репозиторий множество файлов изображений, звуковых эффектов и других файлов игровых ресурсов, каждый раз начиная с

```bash
$ git push origin master

Enter passphrase for key '/home/git/.ssh/id_ed25519':
Locking support detected on remote "origin". Consider enabling it with:
  $ git config lfs.https://gitee.ru/hightest/lfs-demo.git/info/lfs.locksverify true
Enumerating objects: 4, done.
Counting objects: 100% (4/4), done.
Delta compression using up to 6 threads
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 388.92 MiB | 928.00 KiB/s, done.
Total 3 (delta 1), reused 0 (delta 0), pack-reused 0
remote: Powered by gitee.ru [GNK-6.1]
remote: error: File: bcd245bbd11e6b1d71b5d3073f57007c4c002c4a 388.97 MB, exceeds 300.00 MB.
remote: Use command below to see the filename:
remote: git rev-list --objects --all | grep bcd245bbd11e6b1d71b5d3073f57007c4c002c4a
remote: Please remove the file from history and try again. (https://gitee.ru/help/articles/4232)
To gitee.ru:hightest/lfs-demo.git
 ! [remote rejected] master -> master (pre-receive hook declined)
error: failed to push some refs to 'gitee.ru:hightest/lfs-demo.git'
```

Очевидно, что запрос был отклонён, поскольку один файл был слишком большим и превышал квоту в 300 МБ.

В то же время вы чувствуете, что различные базовые операции Git выполняются медленно и с задержками.

На этот раз, вдохновившись Сценарием 1, вы думаете об использовании службы LFS Gitee для управления большими файлами, а в репозитории хранится только информация об указателях, что позволяет избежать этой проблемы.

+ **Управление большими файлами в истории с помощью LFS:**

Если некоторые большие файлы уже были зафиксированы в репозитории, выполнение команды 'git lfs track' будет неэффективным.

Чтобы применить существующие большие файлы в репозитории к LFS, необходимо импортировать их в LFS с помощью 'git lfs migrate':

```bash
$ git lfs migrate import --include-ref=master --include="biger.zip"
migrate: override changes in your working copy?  All uncommitted changes will be lost! [y/N] y
migrate: changes in your working copy will be overridden ...
migrate: Sorting commits: ..., done.
migrate: Rewriting commits: 100% (11/11), done.
  master        f9be3c554e9010ea5e0e23a6a0c6e53dca6c23b0 -> 53d5e655fe7cfd985f75384b92ac5414ad2ff394
migrate: Updating refs: ..., done.
migrate: checkout: ..., done.
```

> Параметр --include-ref указывает ветку для импорта.
>
> Используйте параметр --everything, если хотите применить его ко всем ветвям.
>
> Параметр --include указывает файлы для импорта. Для пакетного импорта можно использовать подстановочные знаки.

Описанная выше операция перепишет историю коммитов. Если вы не хотите переписывать историю, используйте опцию `--no-rewrite` и предоставьте новое сообщение о фиксации.

```bash
git lfs migrate import --no-rewrite -m "lfs import"
```

После включения файлов из локальных исторических коммитов в управление LFS, если вы снова изменяете историю и снова проталкиваете код, вам нужно использовать force push.

Здесь мы выбираем изменение истории коммитов, поэтому для принудительной отправки данных также нужно использовать `--force`:

```bash
$ git push origin master --force

Enter passphrase for key '/home/git/.ssh/id_ed25519':
Locking support detected on remote "origin". Consider enabling it with:
  $ git config lfs.https://gitee.ru/hightest/lfs-demo.git/info/lfs.locksverify true
Uploading LFS objects: 100% (8/8), 419 MB | 0 B/s, done.
Enumerating objects: 38, done.
Counting objects: 100% (38/38), done.
Delta compression using up to 6 threads
Compressing objects: 100% (37/37), done.
Writing objects: 100% (38/38), 136.26 MiB | 943.00 KiB/s, done.
Total 38 (delta 12), reused 10 (delta 0), pack-reused 0
remote: Powered by gitee.ru [GNK-6.1]
To gitee.ru:hightest/lfs-demo.git
 + cefd169...53d5e65 master -> master (forced update)
```

К этому моменту большие файлы в исторических коммитах были перенесены на удаленный сервер LFS. В локальном Git-репозитории сохраняется только файл-указатель этого большого файла. Поэтому при проталкивании больше не будет срабатывать ограничение квоты. После успешного проталкивания удаленный репозиторий будет соответствовать локальному репозиторию, как показано на диаграмме в сценарии 1. Он управляет только файлом-указателем этого большого файла.

После успешной отправки данных на странице **Управление репозиторием** вы можете увидеть следующее: 

![image.png](https://images.gitee.ru/uploads/images/2021/0928/015631_38f12078_7670704.png)

Отображаемый здесь размер - это реальный размер файлов, управляемых LFS-сервером, в то время как размер, управляемый Git-репозиторием, составляет 134 байта!

![image.png](https://images.gitee.ru/uploads/images/2021/0928/100812_6f9ec420_7670704.png)

---

##### Сценарий 3

Будучи активным пользователем Git, вы должны использовать Git для управления файлами в своей повседневной работе. Однако, испытав на себе описанный выше процесс переписывания исторических коммитов и загрузки на сервер LFS, вы научились настраивать функцию LFS в репозитории с самого начала, чтобы гарантировать, что каждый коммит и push будут идеальными.

В новом проекте, на начальном этапе, вы уже настроили LFS. В этот момент появился файл большего размера под названием `biggerthanbigger.zip`, размер которого составляет **778M** и значительно превышает лимит на размер отдельного файла.

Использование LFS для управления вновь добавленными большими файлами

```bash
cd new-project
git add biggerthanbigger.zip
git commit -m "add bigger than bigger zip file"
```

Затем выполните отправку данных в удаленный репозиторий, и, поскольку используется сервис LFS, **эта отправка не должна быть отклонена, если не возникнет неожиданной ошибки**.

```bash
$ git push origin master
Enter passphrase for key '/home/git/.ssh/id_ed25519':
Locking support detected on remote "origin". Consider enabling it with:
  $ git config lfs.https://gitee.ru/hightest/new-project.git/info/lfs.locksverify true
Uploading LFS objects: 100% (3/3), 1.2 MB | 0 B/s, done.
Enumerating objects: 11, done.
Counting objects: 100% (11/11), done.
Delta compression using up to 6 threads
Compressing objects: 100% (10/10), done.
Writing objects: 100% (10/10), 1.56 KiB | 1.56 MiB/s, done.
Total 10 (delta 2), reused 0 (delta 0), pack-reused 0
remote: Powered by gitee.ru [GNK-6.1]
To gitee.ru:hightest/new-project.git
   dfe8b09..5f03bab  master -> master
```

**Однако в реальности могут возникнуть аварийные ситуации!**

Из-за большого размера перетаскиваемых файлов можно превысить квоту LFS, и перетаскивание может завершиться неудачей. Хотя LFS специально разработана для управления большими файлами, все же существует ограничение на хранение больших файлов, поскольку это не служба хранения файлов.

Ограничения на хранение больших файлов в Gitee LFS приведены в пояснениях к квоте ниже.

---

### Описание квоты Gitee LFS

В настоящее время функциональность LFS доступна только для платных предприятий, и подробная квота выглядит следующим образом:

| Бесплатная версия | Базовая версия | Стандартная версия | Улучшенная версия | Эксклюзивная версия | Версия для частного развертывания |
| ------ | ------ | ------ | ------ | ------ | ------------ |
| 0 ГБ   | 1 ГБ   | 1 ГБ   | 1 ГБ   | 1 ГБ   |
  Неограниченно         |

> Ссылка на запрос: <https://gitee.ru/enterprises#price>

Для предприятий, которые включили функциональность LFS и хотят просмотреть использование LFS для каждого репозитория, перейдите на панель управления предприятия. Если название предприятия - My-Enterprise, URL-адрес будет <https://e.gitee.ru/My-Enterprise/dashboard>.

![image.png](https://images.gitee.ru/uploads/images/2021/0928/102835_3598e735_7670704.png)

---

Чтобы проверить использование емкости LFS для каждого репозитория предприятия, перейдите в рабочую область предприятия, выберите элемент 'Extensions' на панели управления и нажмите 'LFS', чтобы просмотреть подробную информацию.

![image.png](https://images.gitee.ru/uploads/images/2021/0928/021431_a4e572f1_7670704.png)

Вы можете увидеть использование каждого репозитория, использующего функцию LFS на предприятии, а также общее использование. Нажав на имени репозитория, вы также перейдете на страницу управления этим репозиторием.

---

Если на предприятии высок спрос на большие файлы и текущей емкости в 1 ГБ недостаточно, не волнуйтесь, у Gitee есть решение - саморасширение.

В рабочей области управления предприятием на верхнем уровне есть ссылка [Renew/Upgrade/Expand], которая ведет прямо на страницу обновления и расширения.

![image.png](https://images.gitee.ru/uploads/images/2021/0928/022039_7e90f00c_7670704.png)

В соответствии с требованиями предприятия максимальное настраиваемое пространство LFS составляет 100 ГБ, что достаточно для большинства проектов с точки зрения пространства.

---

### Краткий итог

Git LFS - это простой в установке, настройке и использовании инструмент расширения Git, который эффективно управляет большими файлами в репозиториях, предотвращая чрезмерный размер репозитория и снижая эффективность управления проектами. В то же время, Gitee

---

### Ссылки для справок

<https://git-lfs.github.com/>

<https://git-scm.com/docs/gitattributes>

<https://zzz.buzz/zh/2016/04/19/the-guide-to-git-lfs/>